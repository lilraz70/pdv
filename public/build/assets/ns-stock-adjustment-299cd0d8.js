import{a as y,b as h,P as p}from"./bootstrap-b8cd97d4.js";import{n as P}from"./ns-procurement-quantity-8246b955.js";import{n as v,d as S,b as x}from"./ns-prompt-popup-4f52d15c.js";import{_ as a,n as q}from"./currency-dc6217f5.js";import{m as A,w as C}from"./npm~@vue~runtime-dom_-2c8e0ca9.js";import{_ as g}from"./_plugin-vue_export-helper-c27b6911.js";import{f as T}from"./npm~rxjs-eeb06f17.js";import{an as V,af as l,G as u,H as t,aJ as U,F as j,al as k,A as b,M as f,z as L,aH as w,c as N}from"./npm~@vue~runtime-core_-0a26b3ab.js";import{V as c}from"./npm~@vue~shared_-5bb087a6.js";import"./npm~lodash-3db1c062.js";import"./npm~@ckeditor~ckeditor5-build-classic_-b5d88964.js";import"./npm~laravel-echo-0c2ba8ed.js";import"./npm~pusher-js-bd96ae31.js";import"./npm~axios-c24e582b.js";import"./npm~chart.js-3fed1729.js";import"./npm~moment-a9aaa855.js";import"./npm~vue-0182d78b.js";import"./npm~@vue~compiler-dom_-ce2c1e21.js";import"./npm~@vue~compiler-core_-745c8708.js";import"./npm~@vue~reactivity_-26e9e2f4.js";import"./npm~rx-f450d610.js";import"./npm~@wordpress~hooks_-bd0b7221.js";import"./npm~mathjs-b10bd4cd.js";import"./npm~@babel~runtime_-9313f80d.js";import"./npm~decimal.js-d133ee8e.js";import"./npm~complex.js-dc0d19c5.js";import"./npm~fraction.js-cb0643cb.js";import"./npm~typed-function-de33f2d8.js";import"./npm~seedrandom-37239647.js";import"./npm~javascript-natural-sort-11e7fc54.js";import"./npm~escape-latex-404addb9.js";import"./npm~tslib-8dbab242.js";import"./npm~numeral-304d6dd9.js";import"./npm~currency.js-57f74176.js";import"./npm~@ckeditor~ckeditor5-vue_-4438b480.js";const B={name:"ns-stock-adjustment",props:["actions"],data(){return{search:"",timeout:null,suggestions:[],products:[]}},mounted(){},methods:{__:a,nsCurrency:q,searchProduct(e){e.length>0&&y.post("/api/procurements/products/search-procurement-product",{argument:e}).subscribe(s=>{if(s.from==="products")if(s.products.length>0)s.products.length===1?this.addSuggestion(s.products[0]):this.suggestions=s.products;else return this.closeSearch(),h.error(a("Looks like no valid products matched the searched term.")).subscribe();else if(s.from==="procurements"){if(s.product===null)return this.closeSearch(),h.error(a("Looks like no valid products matched the searched term.")).subscribe();this.addProductToList(s.product)}})},addProductToList(e){if(this.products.filter(i=>i.procurement_product_id===e.id).length>0)return this.closeSearch(),h.error(a("The product already exists on the table.")).subscribe();const r=this.actions.filter(i=>i.value==="deleted");let d=r.length===1?r[0]:{value:"deleted"};const n=new Object;e.unit_quantity.unit=e.unit,n.selected=!1,n.quantities=[e.unit_quantity],n.name=e.name,n.adjust_unit=e.unit_quantity,n.adjust_quantity=1,n.adjust_action=d.value,n.adjust_reason="",n.adjust_value=0,n.id=e.product_id,n.accurate_tracking=1,n.available_quantity=e.available_quantity,n.procurement_product_id=e.id,n.procurement_history=[{label:`${e.procurement.name} (${e.available_quantity})`,value:e.id}],this.recalculateProduct(n),this.products.unshift(n),this.clearSearch()},addSuggestion(e){const s=this.products.filter(r=>r.id===e.id).length>0;T([y.get(`/api/products/${e.id}/units/quantities`)]).subscribe(r=>{if(r[0].length>0){const d=r[0].filter(_=>_.unit.base_unit),n=this.actions.filter(_=>_.value==="deleted");let i=n.length===1?n[0]:{value:"deleted"};e.selected=!1,e.quantities=r[0],e.adjust_quantity=1,e.adjust_action=i.value,e.adjust_reason="",e.adjust_unit=d.length>0&&!s?d[0]:"",e.adjust_value=0,e.procurement_product_id=0,this.recalculateProduct(e),this.products.unshift(e),this.clearSearch()}else return h.error(a("This product doesn't have any stock to adjust.")).subscribe();e.accurate_tracking})},closeSearch(){this.$refs.searchField.select(),this.suggestions=[]},clearSearch(){this.search="",this.suggestions=[]},recalculateProduct(e){e.adjust_unit!==""&&(["deleted","defective","lost"].includes(e.adjust_action)?e.adjust_value=-(e.adjust_quantity*e.adjust_unit.sale_price):e.adjust_value=e.adjust_quantity*e.adjust_unit.sale_price),this.$forceUpdate()},openQuantityPopup(e){e.quantity,new Promise((r,d)=>{p.show(P,{resolve:r,reject:d,quantity:e.adjust_quantity})}).then(r=>{if(!["added","set"].includes(e.adjust_action)){if(e.accurate_tracking!==void 0&&r.quantity>e.available_quantity)return h.error(a("The specified quantity exceed the available quantity.")).subscribe();if(r.quantity>e.adjust_unit.quantity)return h.error(a("The specified quantity exceed the available quantity.")).subscribe()}e.adjust_quantity=r.quantity,this.recalculateProduct(e)})},proceedStockAdjustment(){if(this.products.length===0)return h.error(a("Unable to proceed as the table is empty.")).subscribe();p.show(v,{title:a("Confirm Your Action"),message:a("The stock adjustment is about to be made. Would you like to confirm ?"),onAction:e=>{e&&y.post("/api/products/adjustments",{products:this.products}).subscribe(s=>{h.success(s.message).subscribe(),this.products=[]},s=>{h.error(s.message).subscribe()})}})},provideReason(e){new Promise((r,d)=>{p.show(S,{title:a("More Details"),resolve:r,reject:d,message:a("Useful to describe better what are the reasons that leaded to this adjustment."),input:e.adjust_reason,onAction:n=>{n!==!1&&(e.adjust_reason=n)}})}).then(r=>{h.success(a("The reason has been updated.")).susbcribe()}).catch(r=>{})},async selectAdjustmentUnit(e){try{const s=await new Promise((i,_)=>{p.show(x,{label:a("Select Unit"),resolve:i,reject:_,description:a("Select the unit that you want to adjust the stock with."),name:"adjust_unit",options:e.quantities.map(o=>({label:o.unit.name,value:o}))})}),r=this.products.indexOf(e);if(this.products.filter((i,_)=>_!==r).filter(i=>i.adjust_unit.unit.id===s.unit.id&&i.adjust_unit.product_id===s.product_id).length>0)return h.error(a("A similar product with the same unit already exists.")).subscribe();e.adjust_unit=s,this.recalculateProduct(e)}catch{}},async selectProcurement(e){try{console.log(e);const s=await new Promise((r,d)=>{p.show(x,{label:a("Select Procurement"),resolve:r,reject:d,description:a("Select the procurement that you want to adjust the stock with."),name:"adjust_procurement",options:e.procurement_history})});e.procurement_product_id=s,this.recalculateProduct(e)}catch(s){throw s}},async selectStockAdjustementAction(e){try{const s=await new Promise((r,d)=>{p.show(x,{label:a("Select Action"),resolve:r,reject:d,description:a("Select the action that you want to perform on the stock."),name:"adjust_action",options:this.actions})});e.adjust_action=s}catch(s){throw s}},removeProduct(e){p.show(v,{title:a("Confirm Your Action"),message:a("Would you like to remove this product from the table ?"),onAction:s=>{if(s){const r=this.products.indexOf(e);this.products.splice(r,1)}}})},getAdjustActionLabel(e){const s=this.actions.filter(r=>r.value===e);return s.length>0?s[0].label:a("N/A")},deleteSelectedProducts(){p.show(v,{title:a("Confirm Your Action"),message:a("Would you like to remove the selected products from the table ?"),onAction:e=>{e&&(this.products=this.products.filter(s=>!s.selected))}})}},watch:{search(){this.search.length>0?(clearTimeout(this.timeout),this.timeout=setTimeout(()=>{this.searchProduct(this.search)},500)):this.closeSearch()}}},D={class:"input-field flex border-2 input-group rounded"},F={class:"px-3 py-2 rounded-none"},O={key:0,class:"h-0"},Q={class:""},R={class:"shadow h-96 relative z-10 ns-vertical-menu zoom-in-entrance anim-duration-300 overflow-y-auto"},z=["onClick"],H={class:"ns-box rounded shadow my-2 w-full"},M={class:"table w-full ns-table"},W={class:"border-b"},Y={class:"p-2"},J={width:"120",class:"p-2 text-center hidden md:table-cell"},K={width:"120",class:"p-2 text-center hidden md:table-cell"},E={key:0},G={class:"p-2 border-b text-center hidden md:table-cell",colspan:"6"},I={class:"p-2 border-b text-center table-cell md:hidden",colspan:"4"},X={class:"p-2 border"},Z=["onClick"],$=["checked"],ee={class:"flex -mx-2 md:flex-row flex-wrap"},te=["onClick"],se={class:"text-xs cursor-pointer border-b border-dashed border-info-secondary py-1"},ie={class:"text-xs"},oe={key:0,class:""},ne={key:1},re=["onClick"],ae={class:"text-xs cursor-pointer border-b border-dashed border-info-secondary py-1"},ce={class:"text-xs"},de={class:""},le=["onClick"],ue={class:"text-xs cursor-pointer border-b border-dashed border-info-secondary py-1"},he={class:"text-xs"},_e={class:""},me=["onClick"],pe={class:"text-xs cursor-pointer border-b border-dashed border-info-secondary py-1"},be={class:"text-xs"},fe={key:0},ye={key:1},ve=["onClick"],xe={class:"text-xs cursor-pointer border-b border-dashed border-danger-secondary py-1"},je={class:"text-xs"},ke=["onClick"],we={class:"flex items-center justify-center cursor-pointer"},Pe={class:"border-b border-dashed border-info-secondary py-2 px-4"},Se={class:"p-2 border hidden md:table-cell"},qe={class:"flex items-center justify-center"},Ae={class:"border-b border-dashed border-info-secondary py-2 px-4"},Ce={class:"ns-box-footer p-2 flex justify-end"},ge={class:"-mx-2 flex"},Te={class:"px-2"},Ve=t("div",{class:"flex items-center justify-center h-6"},[t("i",{class:"las la-trash"})],-1),Ue={class:"hidden md:inline-block"},Le={class:"px-2"};function Ne(e,s,r,d,n,i){const _=V("ns-button");return l(),u("div",null,[t("div",D,[U(t("input",{onKeyup:s[0]||(s[0]=C(o=>i.closeSearch(),["esc"])),ref:"searchField","onUpdate:modelValue":s[1]||(s[1]=o=>n.search=o),type:"text",class:"p-2 flex-auto outline-none"},null,544),[[A,n.search]]),t("button",F,c(i.__("Search")),1)]),n.suggestions.length>0?(l(),u("div",O,[t("div",Q,[t("ul",R,[(l(!0),u(j,null,k(n.suggestions,o=>(l(),u("li",{onClick:m=>i.addSuggestion(o),key:o.id,class:"cursor-pointer border-b p-2 flex justify-between"},[t("span",null,c(o.name),1)],8,z))),128))])])])):b("",!0),t("div",H,[t("table",M,[t("thead",W,[t("tr",null,[t("td",Y,c(i.__("Product")),1),t("td",J,c(i.__("Quantity")),1),t("td",K,c(i.__("Value")),1)])]),t("tbody",null,[n.products.length===0?(l(),u("tr",E,[t("td",G,c(i.__("Search and add some products")),1),t("td",I,c(i.__("Search and add some products")),1)])):b("",!0),(l(!0),u(j,null,k(n.products,o=>(l(),u("tr",{key:o.id},[t("td",X,[t("h3",{class:"font-bold cursor-pointer",onClick:m=>o.selected=!o.selected},[t("input",{type:"checkbox",checked:o.selected,name:"",id:""},null,8,$),f(" "+c(o.name)+" ("+c((o.accurate_tracking===1?o.available_quantity:o.adjust_unit.quantity)||0)+")",1)],8,Z),t("div",ee,[t("div",{class:"px-2 w-1/2 md:w-auto",onClick:m=>i.selectAdjustmentUnit(o)},[t("div",se,[t("span",ie,c(i.__("Unit:")),1),f("  "),o.adjust_unit.unit?(l(),u("span",oe,c(o.adjust_unit.unit.name),1)):b("",!0),o.adjust_unit.unit?b("",!0):(l(),u("span",ne,c(i.__("N/A")),1))])],8,te),t("div",{class:"px-2 w-1/2 md:w-auto",onClick:m=>i.selectStockAdjustementAction(o)},[t("div",ae,[t("span",ce,c(i.__("Operation:")),1),f("  "),t("span",de,c(i.getAdjustActionLabel(o.adjust_action)),1)])],8,re),o.accurate_tracking===1?(l(),u("div",{key:0,class:"px-2 w-1/2 md:w-auto",onClick:m=>i.selectProcurement(o)},[t("div",ue,[t("span",he,c(i.__("Procurement:")),1),f("  "),t("span",_e,c(o.procurement_history.filter(m=>m.value===o.procurement_product_id)[0].label),1)])],8,le)):b("",!0),t("div",{class:"px-2 w-1/2 md:w-auto",onClick:m=>i.provideReason(o)},[t("div",pe,[t("span",be,c(i.__("Reason:")),1),f("  "),o.adjust_reason?(l(),u("span",fe,c(i.__("Provided")),1)):(l(),u("span",ye,c(i.__("Not Provided")),1))])],8,me),t("div",{class:"px-2 w-1/2 md:w-auto",onClick:m=>i.removeProduct(o)},[t("div",xe,[t("span",je,c(i.__("Delete")),1)])],8,ve)])]),t("td",{class:"p-2 border hidden md:table-cell",onClick:m=>i.openQuantityPopup(o)},[t("div",we,[t("span",Pe,c(o.adjust_quantity),1)])],8,ke),t("td",Se,[t("div",qe,[t("span",Ae,c(i.nsCurrency(o.adjust_value)),1)])])]))),128))])]),t("div",Ce,[t("div",ge,[t("div",Te,[n.products.filter(o=>o.selected).length>0?(l(),L(_,{key:0,onClick:s[2]||(s[2]=o=>i.deleteSelectedProducts()),type:"error"},{default:w(()=>[Ve,t("span",Ue,c(i.__("Remove Selected")),1)]),_:1})):b("",!0)]),t("div",Le,[N(_,{onClick:s[3]||(s[3]=o=>i.proceedStockAdjustment()),type:"info"},{default:w(()=>[f(c(i.__("Proceed")),1)]),_:1})])])])])])}const bt=g(B,[["render",Ne]]);export{bt as default};
